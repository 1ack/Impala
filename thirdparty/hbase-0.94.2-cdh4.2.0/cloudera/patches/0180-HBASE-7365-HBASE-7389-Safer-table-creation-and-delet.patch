From 84be4d48abee1fdffec58f7377ea739dee9bd781 Mon Sep 17 00:00:00 2001
From: Matteo Bertozzi <matteo.bertozzi@cloudera.com>
Date: Thu, 24 Jan 2013 10:44:24 -0800
Subject: [PATCH 180/196] HBASE-7365/HBASE-7389 Safer table creation and deletion using .tmp dir

Reason: Test Failure (Fix admin semantic)
Author: Matteo Bertozzi
Ref: CDH-9551
---
 .../hbase/master/handler/DeleteTableHandler.java   |   29 +++++++++++---------
 1 files changed, 16 insertions(+), 13 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/master/handler/DeleteTableHandler.java b/src/main/java/org/apache/hadoop/hbase/master/handler/DeleteTableHandler.java
index db1ea61..bb42bab 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/handler/DeleteTableHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/handler/DeleteTableHandler.java
@@ -75,25 +75,28 @@ public class DeleteTableHandler extends TableEventHandler {
     MetaEditor.deleteRegions(this.server.getCatalogTracker(), regions);
 
     // 3. Move the table in /hbase/.tmp
+    LOG.debug("Moving table directory to a temp directory");
     MasterFileSystem mfs = this.masterServices.getMasterFileSystem();
     Path tempTableDir = mfs.moveTableToTemp(tableName);
 
-    // 4. Update table descriptor cache
-    this.masterServices.getTableDescriptors().remove(Bytes.toString(tableName));
+    try {
+      // 4. Delete regions from FS (temp directory)
+      FileSystem fs = mfs.getFileSystem();
+      for (HRegionInfo hri: regions) {
+        LOG.debug("Deleting region " + hri.getRegionNameAsString() + " from FS");
+        HFileArchiver.archiveRegion(fs, mfs.getRootDir(),
+            tempTableDir, new Path(tempTableDir, hri.getEncodedName()));
+      }
 
-    // 5. If entry for this table in zk, and up in AssignmentManager, remove it.
-    am.getZKTable().setDeletedTable(Bytes.toString(tableName));
+      // 5. Delete table from FS (temp directory)
+      fs.delete(tempTableDir, true);
+    } finally {
+      // 6. Update table descriptor cache
+      this.masterServices.getTableDescriptors().remove(Bytes.toString(tableName));
 
-    // 6. Delete regions from FS (temp directory)
-    FileSystem fs = mfs.getFileSystem();
-    for (HRegionInfo hri: regions) {
-      LOG.debug("Deleting region " + hri.getRegionNameAsString() + " from FS");
-      HFileArchiver.archiveRegion(fs, mfs.getRootDir(),
-          tempTableDir, new Path(tempTableDir, hri.getEncodedName()));
+      // 7. If entry for this table in zk, and up in AssignmentManager, remove it.
+      am.getZKTable().setDeletedTable(Bytes.toString(tableName));
     }
-
-    // 7. Delete table from FS (temp directory)
-    fs.delete(tempTableDir, true);
   }
 
   @Override
-- 
1.7.0.4

