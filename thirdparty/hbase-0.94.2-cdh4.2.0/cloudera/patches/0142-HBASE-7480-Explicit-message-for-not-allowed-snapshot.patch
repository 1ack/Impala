From 02f4e2d6a29ce1654440f44cbf3c1b1563651226 Mon Sep 17 00:00:00 2001
From: Matteo Bertozzi <matteo.bertozzi@cloudera.com>
Date: Fri, 11 Jan 2013 10:23:12 -0800
Subject: [PATCH 142/196] HBASE-7480 Explicit message for not allowed snapshot on meta tables

Reason: Snapshots
Author: Matteo Bertozzi
Ref: CDH-9551
---
 .../hbase/snapshot/SnapshotDescriptionUtils.java   |    4 +++
 .../hbase/client/TestSnapshotFromClient.java       |   24 ++++++++++++++++++++
 2 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java b/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
index 7753c23..aef853f 100644
--- a/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
+++ b/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
@@ -132,6 +132,10 @@ public class SnapshotDescriptionUtils {
   public static void assertSnapshotRequestIsValid(SnapshotDescription snapshot)
       throws IllegalArgumentException {
     // FIXME these method names is really bad - trunk will probably change
+    // .META. and -ROOT- snapshots are not allowed
+    if (HTableDescriptor.isMetaTable(Bytes.toBytes(snapshot.getTable()))) {
+      throw new IllegalArgumentException(".META. and -ROOT- snapshots are not allowed");
+    }
     // make sure the snapshot name is valid
     HTableDescriptor.isLegalTableName(Bytes.toBytes(snapshot.getName()));
     // make sure the table name is valid
diff --git a/src/test/java/org/apache/hadoop/hbase/client/TestSnapshotFromClient.java b/src/test/java/org/apache/hadoop/hbase/client/TestSnapshotFromClient.java
index f445ad6..e1b5ff8 100644
--- a/src/test/java/org/apache/hadoop/hbase/client/TestSnapshotFromClient.java
+++ b/src/test/java/org/apache/hadoop/hbase/client/TestSnapshotFromClient.java
@@ -119,6 +119,30 @@ public class TestSnapshotFromClient {
   }
 
   /**
+   * Test snapshotting not allowed .META. and -ROOT-
+   * @throws Exception
+   */
+  @Test
+  public void testMetaTablesSnapshot() throws Exception {
+    HBaseAdmin admin = UTIL.getHBaseAdmin();
+    byte[] snapshotName = Bytes.toBytes("metaSnapshot");
+
+    try {
+      admin.snapshot(snapshotName, HConstants.META_TABLE_NAME);
+      fail("taking a snapshot of .META. should not be allowed");
+    } catch (IllegalArgumentException e) {
+      // expected
+    }
+
+    try {
+      admin.snapshot(snapshotName, HConstants.ROOT_TABLE_NAME);
+      fail("taking a snapshot of -ROOT- should not be allowed");
+    } catch (IllegalArgumentException e) {
+      // expected
+    }
+  }
+
+  /**
    * Test snapshotting a table that is offline
    * @throws Exception
    */
-- 
1.7.0.4

