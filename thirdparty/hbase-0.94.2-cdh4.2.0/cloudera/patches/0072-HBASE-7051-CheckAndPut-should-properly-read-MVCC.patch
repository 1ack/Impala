From 670efcc02d7d79e223e6e530a346c6f38eaee7fa Mon Sep 17 00:00:00 2001
From: Lars Hofhansl <larsh@apache.org>
Date: Wed, 31 Oct 2012 22:04:34 +0000
Subject: [PATCH 072/196] HBASE-7051 CheckAndPut should properly read MVCC

Reason: Bug
Author: Lars Hofhansl
Ref: CDH-9524

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.94@1404379 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/hadoop/hbase/regionserver/HRegion.java  |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java b/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
index 778fc55..55128fb 100644
--- a/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
+++ b/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
@@ -2372,6 +2372,8 @@ public class HRegion implements HeapSize { // , Writable{
 
       // Lock row
       Integer lid = getLock(lockId, get.getRow(), true);
+      // wait for all previous transactions to complete (with lock held)
+      mvcc.completeMemstoreInsert(mvcc.beginMemstoreInsert());
       List<KeyValue> result = new ArrayList<KeyValue>();
       try {
         result = get(get, false);
-- 
1.7.0.4

