From f1cc4a506ea9bf6c5408e2387dc25f7210b895a8 Mon Sep 17 00:00:00 2001
From: Himanshu <himanshu@cloudera.com>
Date: Wed, 2 Jan 2013 10:07:34 -0700
Subject: [PATCH 116/196] HBASE-7440 ReplicationZookeeper#addPeer is racy
 Reason: Bug
 Author: Himanshu Vashistha
 Ref: CDH-9622

---
 .../hadoop/hbase/replication/ReplicationPeer.java  |    7 +++++--
 .../hbase/replication/ReplicationZookeeper.java    |   11 +++++++----
 2 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java b/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java
index 0fec27f..12ee9a2 100644
--- a/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java
+++ b/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java
@@ -79,8 +79,11 @@ public class ReplicationPeer implements Abortable {
   public void startStateTracker(ZooKeeperWatcher zookeeper, String peerStateNode)
       throws KeeperException {
     if (ZKUtil.checkExists(zookeeper, peerStateNode) == -1) {
-      ZKUtil.createAndWatch(zookeeper, peerStateNode,
-          Bytes.toBytes(PeerState.ENABLED.name())); // enabled by default
+      // There is a race b/w PeerWatcher and ReplicationZookeeper#add method to create the
+      // peer-state znode. This happens while adding a peer.
+      // The peer state data is set as "ENABLED" by default.
+      ZKUtil.createNodeIfNotExistsAndWatch(zookeeper, peerStateNode,
+        Bytes.toBytes(PeerState.ENABLED.name()));
     }
     this.peerStateTracker = new PeerStateTracker(peerStateNode, zookeeper,
         this);
diff --git a/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java b/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java
index bc20acd..0e73431 100644
--- a/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java
+++ b/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java
@@ -389,10 +389,13 @@ public class ReplicationZookeeper {
         throw new IllegalArgumentException("Cannot add existing peer");
       }
       ZKUtil.createWithParents(this.zookeeper, this.peersZNode);
-      ZKUtil.createAndWatch(this.zookeeper,
-          ZKUtil.joinZNode(this.peersZNode, id), Bytes.toBytes(clusterKey));
-      ZKUtil.createAndWatch(this.zookeeper, getPeerStateNode(id),
-          Bytes.toBytes(PeerState.ENABLED.name())); // enabled by default
+      ZKUtil.createAndWatch(this.zookeeper, ZKUtil.joinZNode(this.peersZNode, id),
+        Bytes.toBytes(clusterKey));
+      // There is a race b/w PeerWatcher and ReplicationZookeeper#add method to create the
+      // peer-state znode. This happens while adding a peer.
+      // The peer state data is set as "ENABLED" by default.
+      ZKUtil.createNodeIfNotExistsAndWatch(this.zookeeper, getPeerStateNode(id),
+        Bytes.toBytes(PeerState.ENABLED.name()));
     } catch (KeeperException e) {
       throw new IOException("Unable to add peer", e);
     }
-- 
1.7.0.4

