From 513b4ef3b1bea4c0e6ba1f1c4b9348a4c4ff51d3 Mon Sep 17 00:00:00 2001
From: Matteo Bertozzi <matteo.bertozzi@cloudera.com>
Date: Wed, 19 Dec 2012 22:27:07 +0000
Subject: [PATCH 093/202] HBASE-7240 Cleanup old snapshots on start

Reason: Snapshots
Author: Jesse Yates
Ref: CDH-9551
---
 .../org/apache/hadoop/hbase/master/HMaster.java    |    1 +
 .../master/snapshot/manage/SnapshotManager.java    |   17 +++++++++++++++++
 .../hbase/snapshot/SnapshotDescriptionUtils.java   |   16 ++++++++++++----
 3 files changed, 30 insertions(+), 4 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
index d5dc097..504f4d6 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
@@ -470,6 +470,7 @@ Server {
     // create the snapshot monitor
     // TODO should this be config based?
     this.snapshotManager = new SnapshotManager(this, zooKeeper, this.executorService);
+    snapshotManager.start();
   }
 
   // Check if we should stop every second.
diff --git a/src/main/java/org/apache/hadoop/hbase/master/snapshot/manage/SnapshotManager.java b/src/main/java/org/apache/hadoop/hbase/master/snapshot/manage/SnapshotManager.java
index 9e94f7f..595513a 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/snapshot/manage/SnapshotManager.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/snapshot/manage/SnapshotManager.java
@@ -81,6 +81,23 @@ public class SnapshotManager implements Stoppable {
   }
 
   /**
+   * Start running the manager.
+   * <p>
+   * <ol>
+   * <li>Cleans up any snapshots in the snapshot/.tmp directory that were left from failed
+   * snapshot/export attempts</li>
+   * </ol>
+   * @throws IOException if we can't reach the filesystem
+   */
+  public void start() throws IOException {
+    // cleanup any existing snapshots.
+    Path tmpdir = SnapshotDescriptionUtils.getWorkingSnapshotDir(rootDir);
+    if (master.getMasterFileSystem().getFileSystem().delete(tmpdir, true)) {
+      LOG.warn("Couldn't delete working snapshot directory: " + tmpdir);
+    }
+  }
+
+  /**
    * @return <tt>true</tt> if there is a snapshot currently being taken, <tt>false</tt> otherwise
    */
   public boolean isTakingSnapshot() {
diff --git a/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java b/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
index 7d61858..2ed0534 100644
--- a/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
+++ b/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotDescriptionUtils.java
@@ -233,14 +233,23 @@ public class SnapshotDescriptionUtils {
   }
 
   /**
+   * Get the general working directory for snapshots - where they are built, where they are
+   * temporarily copied on export, etc.
+   * @param rootDir root directory of the HBase installation
+   * @return Path to the snapshot tmp directory, relative to the passed root directory
+   */
+  public static Path getWorkingSnapshotDir(final Path rootDir) {
+    return new Path(getSnapshotsDir(rootDir), SNAPSHOT_TMP_DIR_NAME);
+  }
+
+  /**
    * Get the directory to build a snapshot, before it is finalized
    * @param snapshot snapshot that will be built
    * @param rootDir root directory of the hbase installation
    * @return {@link Path} where one can build a snapshot
    */
   public static Path getWorkingSnapshotDir(SnapshotDescription snapshot, final Path rootDir) {
-    return getCompletedSnapshotDir(new Path(getSnapshotsDir(rootDir), SNAPSHOT_TMP_DIR_NAME),
-      snapshot.getName());
+    return getCompletedSnapshotDir(getWorkingSnapshotDir(rootDir), snapshot.getName());
   }
 
   /**
@@ -250,8 +259,7 @@ public class SnapshotDescriptionUtils {
    * @return {@link Path} where one can build a snapshot
    */
   public static Path getWorkingSnapshotDir(String snapshotName, final Path rootDir) {
-    return getCompletedSnapshotDir(new Path(getSnapshotsDir(rootDir), SNAPSHOT_TMP_DIR_NAME),
-      snapshotName);
+    return getCompletedSnapshotDir(getWorkingSnapshotDir(rootDir), snapshotName);
   }
 
   /**
-- 
1.7.0.4

