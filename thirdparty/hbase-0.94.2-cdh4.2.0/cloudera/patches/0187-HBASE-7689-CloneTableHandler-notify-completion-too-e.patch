From 5bc9877430854d190eae55ff3fe1ad7f67274f84 Mon Sep 17 00:00:00 2001
From: Matteo Bertozzi <matteo.bertozzi@cloudera.com>
Date: Mon, 28 Jan 2013 10:43:39 -0800
Subject: [PATCH 187/196] HBASE-7689 CloneTableHandler notify completion too early

Reason: Snapshots
Author: Matteo Bertozzi
Ref: CDH-9551
---
 .../hbase/master/handler/CreateTableHandler.java   |   13 ++++++++++---
 .../master/snapshot/CloneSnapshotHandler.java      |    7 +++++--
 2 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java b/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java
index 62ed965..7c1ba08 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java
@@ -135,14 +135,21 @@ public class CreateTableHandler extends EventHandler {
     try {
       LOG.info("Attempting to create the table " + tableName);
       handleCreateTable(tableName);
-    } catch (IOException e) {
-      LOG.error("Error trying to create the table " + tableName, e);
-    } catch (KeeperException e) {
+      completed(null);
+    } catch (Throwable e) {
       LOG.error("Error trying to create the table " + tableName, e);
+      completed(e);
     }
   }
 
   /**
+   * Called after that process() is completed.
+   * @param exception null if process() is successful or not null if something has failed.
+   */
+  protected void completed(final Throwable exception) {
+  }
+
+  /**
    * Responsible of table creation (on-disk and META) and assignment.
    * - Create the table directory and descriptor (temp folder)
    * - Create the on-disk regions (temp folder)
diff --git a/src/main/java/org/apache/hadoop/hbase/master/snapshot/CloneSnapshotHandler.java b/src/main/java/org/apache/hadoop/hbase/master/snapshot/CloneSnapshotHandler.java
index 00aa282..58e6520 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/snapshot/CloneSnapshotHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/snapshot/CloneSnapshotHandler.java
@@ -117,12 +117,15 @@ public class CloneSnapshotHandler extends CreateTableHandler implements Snapshot
       // these handlers aren't futures so we need to register the error here.
       this.monitor.receive(new ForeignException(NAME, rse));
       throw rse;
-    } finally {
-      this.stopped = true;
     }
   }
 
   @Override
+  protected void completed(final Throwable exception) {
+    this.stopped = true;
+  }
+
+  @Override
   public boolean isFinished() {
     return this.stopped;
   }
-- 
1.7.0.4

