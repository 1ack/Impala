From d6c98692451a962f6a0463590cee968f6082c155 Mon Sep 17 00:00:00 2001
From: Himanshu <himanshu@cloudera.com>
Date: Tue, 29 Jan 2013 14:30:22 -0700
Subject: [PATCH 190/202] HBASE-7694 Secure HBase should use replication call queue

Reason: Bug
Author: Jieshan Bean
Ref: CDH-10203
---
 .../org/apache/hadoop/hbase/ipc/SecureServer.java  |    6 ++++++
 .../org/apache/hadoop/hbase/ipc/HBaseServer.java   |    4 ++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java b/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
index c722819..3fa146a 100644
--- a/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
+++ b/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
@@ -21,6 +21,7 @@ package org.apache.hadoop.hbase.ipc;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.hadoop.conf.Configuration;
+import org.apache.hadoop.hbase.HConstants;
 import org.apache.hadoop.hbase.io.HbaseObjectWritable;
 import org.apache.hadoop.hbase.io.WritableWithSize;
 import org.apache.hadoop.hbase.security.HBaseSaslRpcServer;
@@ -609,8 +610,13 @@ public abstract class SecureServer extends HBaseServer {
 
       if (priorityCallQueue != null && getQosLevel(param) > highPriorityLevel) {
         priorityCallQueue.put(call);
+        updateCallQueueLenMetrics(priorityCallQueue);
+      } else if (replicationQueue != null && getQosLevel(param) == HConstants.REPLICATION_QOS) {
+        replicationQueue.put(call);
+        updateCallQueueLenMetrics(replicationQueue);
       } else {
         callQueue.put(call);              // queue the call; maybe blocked here
+        updateCallQueueLenMetrics(callQueue);
       }
     }
 
diff --git a/src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java b/src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java
index e89be5d..0306717 100644
--- a/src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java
+++ b/src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java
@@ -226,7 +226,7 @@ public abstract class HBaseServer implements RpcServer {
   private Handler[] handlers = null;
   private Handler[] priorityHandlers = null;
   /** replication related queue; */
-  private BlockingQueue<Call> replicationQueue;
+  protected BlockingQueue<Call> replicationQueue;
   private int numOfReplicationHandlers = 0;
   private Handler[] replicationHandlers = null;
   protected HBaseRPCErrorHandler errorHandler = null;
@@ -1329,7 +1329,7 @@ public abstract class HBaseServer implements RpcServer {
    * Reports length of the call queue to HBaseRpcMetrics.
    * @param queue Which queue to report
    */
-  private void updateCallQueueLenMetrics(BlockingQueue<Call> queue) {
+  protected void updateCallQueueLenMetrics(BlockingQueue<Call> queue) {
     if (queue == callQueue) {
       rpcMetrics.callQueueLen.set(callQueue.size());
     } else if (queue == priorityCallQueue) {
-- 
1.7.0.4

