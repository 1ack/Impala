From f162c0bdb7ce87013c77df562d5e0e1e52a39ecc Mon Sep 17 00:00:00 2001
From: Jean-Daniel Cryans <jdcryans@cloudera.com>
Date: Thu, 24 Jan 2013 13:07:55 -0800
Subject: [PATCH 181/196] CDH-9875  Take two on fixing loadTesting

---
 .../hbase/replication/TestReplicationBase.java     |    2 +-
 .../replication/TestReplicationSmallTests.java     |   12 ++++++++----
 2 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationBase.java b/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationBase.java
index c57449c..d98d920 100644
--- a/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationBase.java
+++ b/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationBase.java
@@ -62,7 +62,7 @@ public class TestReplicationBase {
   protected static final int NB_ROWS_IN_BATCH = 100;
   protected static final int NB_ROWS_IN_BIG_BATCH =
       NB_ROWS_IN_BATCH * 10;
-  protected static final long SLEEP_TIME = 1000;
+  protected static final long SLEEP_TIME = 500;
   protected static final int NB_RETRIES = 10;
 
   protected static final byte[] tableName = Bytes.toBytes("test");
diff --git a/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationSmallTests.java b/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationSmallTests.java
index 374ea68..576d43e 100644
--- a/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationSmallTests.java
+++ b/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationSmallTests.java
@@ -431,9 +431,9 @@ public class TestReplicationSmallTests extends TestReplicationBase {
     assertEquals(NB_ROWS_IN_BATCH *10, res.length);
 
     scan = new Scan();
-
-    for (int i = 0; i < NB_RETRIES; i++) {
-
+    int lastCount = 0;
+    int i = 0;
+    while(true) {
       scanner = htable2.getScanner(scan);
       res = scanner.next(NB_ROWS_IN_BIG_BATCH);
       scanner.close();
@@ -451,7 +451,11 @@ public class TestReplicationSmallTests extends TestReplicationBase {
           fail("Waited too much time for normal batch replication, "
               + res.length + " instead of " + NB_ROWS_IN_BIG_BATCH);
         } else {
-          LOG.info("Only got " + res.length + " rows");
+          if (lastCount >= res.length) {
+            i++;
+          }
+          lastCount = res.length;
+          LOG.info("Only got " + res.length + " rows, i=" + i);
           Thread.sleep(SLEEP_TIME);
         }
       } else {
-- 
1.7.0.4

