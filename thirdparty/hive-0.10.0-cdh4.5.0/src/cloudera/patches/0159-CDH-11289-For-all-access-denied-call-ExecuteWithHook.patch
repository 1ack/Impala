From 6ca98004f0e9603d974355cbf6f11f9b1ad10405 Mon Sep 17 00:00:00 2001
From: Prasad Mujumdar <prasadm@cloudera.com>
Date: Fri, 12 Jul 2013 19:54:04 -0700
Subject: [PATCH 159/218] CDH-11289: For all access denied call ExecuteWithHookContext for hooktype = failure

---
 ql/src/java/org/apache/hadoop/hive/ql/Driver.java  |    2 +
 .../ql/parse/HiveSemanticAnalyzerHookContext.java  |    8 ++++++
 .../parse/HiveSemanticAnalyzerHookContextImpl.java |   25 ++++++++++++++++++++
 3 files changed, 35 insertions(+), 0 deletions(-)

diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/Driver.java b/src/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
index 7fe3b2d..a2fad60 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
@@ -451,6 +451,8 @@ public class Driver implements CommandProcessor {
         HiveSemanticAnalyzerHookContext hookCtx = new HiveSemanticAnalyzerHookContextImpl();
         hookCtx.setConf(conf);
         hookCtx.setUserName(userName);
+        hookCtx.setIpAddress(ipAddress);
+        hookCtx.setCommand(command);
         for (AbstractSemanticAnalyzerHook hook : saHooks) {
           tree = hook.preAnalyze(hookCtx, tree);
         }
diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContext.java b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContext.java
index 8694d07..b78ce90 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContext.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContext.java
@@ -57,4 +57,12 @@ public interface HiveSemanticAnalyzerHookContext extends Configurable{
   public String getUserName();
 
   public void setUserName(String userName);
+
+  public String getIpAddress();
+
+  public void setIpAddress(String ipAddress);
+
+  public String getCommand();
+
+  public void setCommand(String command);
 }
diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContextImpl.java b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContextImpl.java
index 4f6dad4..d619406 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContextImpl.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/HiveSemanticAnalyzerHookContextImpl.java
@@ -33,6 +33,8 @@ public class HiveSemanticAnalyzerHookContextImpl implements HiveSemanticAnalyzer
   Set<ReadEntity> inputs = null;
   Set<WriteEntity> outputs = null;
   private String userName;
+  private String ipAddress;
+  private String command;
 
   @Override
   public Hive getHive() throws HiveException {
@@ -66,11 +68,34 @@ public class HiveSemanticAnalyzerHookContextImpl implements HiveSemanticAnalyzer
     return outputs;
   }
 
+  @Override
   public String getUserName() {
     return userName;
   }
 
+  @Override
   public void setUserName(String userName) {
     this.userName = userName;
   }
+
+  @Override
+  public String getIpAddress() {
+    return ipAddress;
+  }
+
+  @Override
+  public void setIpAddress(String ipAddress) {
+    this.ipAddress = ipAddress;
+  }
+
+  @Override
+  public String getCommand() {
+    return command;
+  }
+
+  @Override
+  public void setCommand(String command) {
+    this.command = command;
+  }
+
 }
-- 
1.7.0.4

