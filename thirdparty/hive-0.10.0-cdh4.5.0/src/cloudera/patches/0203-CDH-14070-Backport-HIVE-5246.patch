From 522ecaf5542353e460dcf046588805bc27ca127d Mon Sep 17 00:00:00 2001
From: Prasad Mujumdar <prasadm@cloudera.com>
Date: Thu, 19 Sep 2013 21:31:37 -0700
Subject: [PATCH 203/218] CDH-14070 : Backport HIVE-5246

---
 .../org/apache/hadoop/hive/ql/exec/ExecDriver.java |    7 +++----
 .../hadoop/hive/ql/exec/MapredLocalTask.java       |    1 -
 .../apache/hadoop/hive/ql/exec/SecureCmdDoAs.java  |    8 --------
 3 files changed, 3 insertions(+), 13 deletions(-)

diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
index 381a713..d320bbd 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
@@ -586,7 +586,6 @@ public class ExecDriver extends Task<MapredWork> implements Serializable, Hadoop
     boolean noLog = false;
     String files = null;
     boolean localtask = false;
-    String hadoopAuthToken = null;
     try {
       for (int i = 0; i < args.length; i++) {
         if (args[i].equals("-plan")) {
@@ -599,9 +598,6 @@ public class ExecDriver extends Task<MapredWork> implements Serializable, Hadoop
           files = args[++i];
         } else if (args[i].equals("-localtask")) {
           localtask = true;
-        } else if (args[i].equals("-hadooptoken")) {
-          //set with HS2 in secure mode with doAs
-          hadoopAuthToken = args[++i];
         }
       }
     } catch (IndexOutOfBoundsException e) {
@@ -623,6 +619,9 @@ public class ExecDriver extends Task<MapredWork> implements Serializable, Hadoop
     if (files != null) {
       conf.set("tmpfiles", files);
     }
+
+    String hadoopAuthToken =
+        System.getenv(ShimLoader.getHadoopShims().getTokenFileLocEnvName());
     if(hadoopAuthToken != null){
       conf.set("mapreduce.job.credentials.binary", hadoopAuthToken);
     }
diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/MapredLocalTask.java b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/MapredLocalTask.java
index f12064f..eed2321 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/MapredLocalTask.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/MapredLocalTask.java
@@ -222,7 +222,6 @@ public class MapredLocalTask extends Task<MapredLocalWork> implements Serializab
         // then additional params need to be set so that the command is run as
         // intended user
         SecureCmdDoAs secureDoAs = new SecureCmdDoAs(conf);
-        cmdLine = secureDoAs.addArg(cmdLine);
         secureDoAs.addEnv(variables);
       }
 
diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/SecureCmdDoAs.java b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/SecureCmdDoAs.java
index a9a9874..39e5c70 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/exec/SecureCmdDoAs.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/exec/SecureCmdDoAs.java
@@ -39,14 +39,6 @@ public class SecureCmdDoAs {
     tokenPath = ShimLoader.getHadoopShims().createDelegationTokenFile(conf);
   }
 
-  public String addArg(String cmdline) throws HiveException {
-    StringBuilder sb = new StringBuilder();
-    sb.append(cmdline);
-    sb.append(" -hadooptoken ");
-    sb.append(tokenPath.toUri().getPath());
-    return sb.toString();
-  }
-
   public void addEnv(Map<String, String> env){
     env.put(UserGroupInformation.HADOOP_TOKEN_FILE_LOCATION,
         tokenPath.toUri().getPath());
-- 
1.7.0.4

