From f342e9d5509beac293a1d35546e9d71dd9b8b7db Mon Sep 17 00:00:00 2001
From: Gregory Chanan <gchanan@cloudera.com>
Date: Thu, 9 Aug 2012 17:53:08 -0700
Subject: [PATCH 106/151] HBASE-6552 TestAcidGuarantees system test should flush more aggresively (Gregory Chanan)

Reason: System Test Improvement
Author: Gregory Chanan
Ref: CDH-7230
---
 .../apache/hadoop/hbase/TestAcidGuarantees.java    |   26 ++++++-------------
 1 files changed, 8 insertions(+), 18 deletions(-)

diff --git a/src/test/java/org/apache/hadoop/hbase/TestAcidGuarantees.java b/src/test/java/org/apache/hadoop/hbase/TestAcidGuarantees.java
index 01c8b5a..e2230c4 100644
--- a/src/test/java/org/apache/hadoop/hbase/TestAcidGuarantees.java
+++ b/src/test/java/org/apache/hadoop/hbase/TestAcidGuarantees.java
@@ -30,6 +30,7 @@ import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.hbase.MultithreadedTestUtil.RepeatingTestThread;
 import org.apache.hadoop.hbase.MultithreadedTestUtil.TestContext;
 import org.apache.hadoop.hbase.client.Get;
+import org.apache.hadoop.hbase.client.HBaseAdmin;
 import org.apache.hadoop.hbase.client.HTable;
 import org.apache.hadoop.hbase.client.Put;
 import org.apache.hadoop.hbase.client.Result;
@@ -240,15 +241,6 @@ public class TestAcidGuarantees implements Tool {
       int numGetters,
       int numScanners,
       int numUniqueRows) throws Exception {
-      runTestAtomicity(millisToRun, numWriters, numGetters, numScanners,
-		       numUniqueRows, true);
-  }
-
-  public void runTestAtomicity(long millisToRun,
-      int numWriters,
-      int numGetters,
-      int numScanners,
-      int numUniqueRows, boolean useFlusher) throws Exception {
     createTableIfMissing();
     TestContext ctx = new TestContext(util.getConfiguration());
     
@@ -265,13 +257,12 @@ public class TestAcidGuarantees implements Tool {
       ctx.addThread(writer);
     }
     // Add a flusher
-    if (useFlusher) {
-      ctx.addThread(new RepeatingTestThread(ctx) {
-        public void doAnAction() throws Exception {
-          util.flush();
-        }
-      });
-    }
+    ctx.addThread(new RepeatingTestThread(ctx) {
+      HBaseAdmin admin = new HBaseAdmin(util.getConfiguration());
+      public void doAnAction() throws Exception {
+        admin.flush(TABLE_NAME);
+      }
+    });
 
     List<AtomicGetReader> getters = Lists.newArrayList();
     for (int i = 0; i < numGetters; i++) {
@@ -359,8 +350,7 @@ public class TestAcidGuarantees implements Tool {
     int numGetters = c.getInt("numGetters", 2);
     int numScanners = c.getInt("numScanners", 2);
     int numUniqueRows = c.getInt("numUniqueRows", 3);
-    // cannot run flusher in real cluster case.
-    runTestAtomicity(millis, numWriters, numGetters, numScanners, numUniqueRows, false);
+    runTestAtomicity(millis, numWriters, numGetters, numScanners, numUniqueRows);
     return 0;
   }
 
-- 
1.7.0.4

