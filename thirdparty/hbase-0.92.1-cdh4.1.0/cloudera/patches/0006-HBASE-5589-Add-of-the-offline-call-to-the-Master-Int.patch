From de0f8fd77f3f781565e5df1d992bc69fbf775d07 Mon Sep 17 00:00:00 2001
From: Jonathan Hsieh <jmhsieh@apache.org>
Date: Wed, 21 Mar 2012 23:48:45 +0000
Subject: [PATCH 006/154] HBASE-5589 Add of the offline call to the Master Interface

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.92@1303621 13f79535-47bb-0310-9956-ffa450edef68

Reason: hbck prerequisite
Author: Jonahtan Hsieh
Ref: CDH-4040
---
 .../apache/hadoop/hbase/ipc/HMasterInterface.java  |   16 ++++++++++++++++
 .../org/apache/hadoop/hbase/master/HMaster.java    |   13 +++++++++++++
 2 files changed, 29 insertions(+), 0 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java b/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
index e5de506..5c30f50 100644
--- a/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
+++ b/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
@@ -51,6 +51,10 @@ public interface HMasterInterface extends VersionedProtocol {
   // meant all HBase RPC was broke though only one of the three RPC Interfaces
   // had changed.  This has since been undone.
   // 29:  4/3/2010 - changed ClusterStatus serialization
+  // 30: 3/20/2012 - HBASE-5589: Added offline method 
+	
+  // NOTE: Not bumped from 29 to maintain compatibility since this addition is
+  // after the v0.92.0 release.
   public static final long VERSION = 29L;
 
   /** @return true if master is available */
@@ -213,6 +217,18 @@ public interface HMasterInterface extends VersionedProtocol {
   public void unassign(final byte [] regionName, final boolean force)
   throws IOException;
 
+  
+  /**
+   * Offline a region from the assignment manager's in-memory state.  The
+   * region should be in a closed state and there will be no attempt to
+   * automatically reassign the region as in unassign.   This is a special
+   * method, and should only be used by experts or hbck.
+   * @param regionName Region to offline.  Will clear any existing RegionPlan
+   * if one found.
+   * @throws IOException
+   */
+  public void offline(final byte[] regionName) throws IOException;
+
   /**
    * Run the balancer.  Will run the balancer and if regions to move, it will
    * go ahead and do the reassignments.  Can NOT run for various reasons.  Check
diff --git a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
index 7f1331d..231f05e 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
@@ -1603,6 +1603,19 @@ Server {
   public double getAverageLoad() {
     return this.assignmentManager.getAverageLoad();
   }
+  
+  /**
+   * Special method, only used by hbck.
+   */
+  @Override
+  public void offline(final byte[] regionName) 
+  throws IOException {
+    Pair<HRegionInfo, ServerName> pair =
+      MetaReader.getRegion(this.catalogTracker, regionName);
+    if (pair == null) throw new UnknownRegionException(Bytes.toStringBinary(regionName));
+    HRegionInfo hri = pair.getFirst();
+    this.assignmentManager.regionOffline(hri);    
+  }
 
   /**
    * Utility for constructing an instance of the passed HMaster class.
-- 
1.7.0.4

