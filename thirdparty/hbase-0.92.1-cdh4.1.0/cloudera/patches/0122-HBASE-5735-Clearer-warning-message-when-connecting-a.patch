From 00cca81375f016a794e1be19765c4213cc4cf10c Mon Sep 17 00:00:00 2001
From: Gregory Chanan <gchanan@cloudera.com>
Date: Mon, 27 Aug 2012 17:12:05 -0700
Subject: [PATCH 122/154] HBASE-5735 Clearer warning message when connecting a non-secure HBase client to a secure HBase server

Reason: Supportability
Author: Shaneal Manek
Ref: CDH-5549
---
 .../org/apache/hadoop/hbase/ipc/SecureServer.java  |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java b/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
index 0766f5d..e9df30d 100644
--- a/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
+++ b/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureServer.java
@@ -47,6 +47,8 @@ import org.apache.hadoop.security.token.TokenIdentifier;
 import org.apache.hadoop.util.ReflectionUtils;
 import org.apache.hadoop.util.StringUtils;
 
+import com.google.common.collect.ImmutableSet;
+
 import javax.security.sasl.Sasl;
 import javax.security.sasl.SaslException;
 import javax.security.sasl.SaslServer;
@@ -83,6 +85,7 @@ public abstract class SecureServer extends HBaseServer {
   // 3 : Introduce the protocol into the RPC connection header
   // 4 : Introduced SASL security layer
   public static final byte CURRENT_VERSION = 4;
+  public static final Set<Byte> INSECURE_VERSIONS = ImmutableSet.of((byte) 3);
 
   public static final Log LOG = LogFactory.getLog("org.apache.hadoop.ipc.SecureServer");
   private static final Log AUDITLOG =
@@ -400,10 +403,17 @@ public abstract class SecureServer extends HBaseServer {
           dataLengthBuffer.flip();
           if (!HEADER.equals(dataLengthBuffer) || version != CURRENT_VERSION) {
             //Warning is ok since this is not supposed to happen.
-            LOG.warn("Incorrect header or version mismatch from " +
-                     hostAddress + ":" + remotePort +
-                     " got version " + version +
-                     " expected version " + CURRENT_VERSION);
+            if (INSECURE_VERSIONS.contains(version)) {
+              LOG.warn("An insecure client (version '" + version + "') is attempting to connect " +
+                  " to this version '" + CURRENT_VERSION + "' secure server from " +
+                  hostAddress + ":" + remotePort);
+            } else {
+              LOG.warn("Incorrect header or version mismatch from " +
+                  hostAddress + ":" + remotePort +
+                  " got version " + version +
+                  " expected version " + CURRENT_VERSION);              
+            }
+            
             return -1;
           }
           dataLengthBuffer.clear();
-- 
1.7.0.4

