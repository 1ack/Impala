From df8b90f243a6d1f73f4fbf0561d7e6b118b8e480 Mon Sep 17 00:00:00 2001
From: Gregory Chanan <gchanan@cloudera.com>
Date: Wed, 25 Jul 2012 14:38:04 -0700
Subject: [PATCH 080/154] HBASE-5874 When 'fs.default.name' not configured, the hbck tool and Merge tool throws IllegalArgumentException (fulin wang)

Reason: Backport
Author: Fulin Wang
Ref: CDH-6919
---
 .../org/apache/hadoop/hbase/util/HBaseFsck.java    |    6 +++++-
 .../java/org/apache/hadoop/hbase/util/Merge.java   |    8 ++++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java
index ab45808..3d7a2bf 100644
--- a/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java
+++ b/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java
@@ -18,6 +18,7 @@
 package org.apache.hadoop.hbase.util;
 
 import java.io.IOException;
+import java.net.URI;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Collections;
@@ -3019,7 +3020,10 @@ public class HBaseFsck {
 
     // create a fsck object
     Configuration conf = HBaseConfiguration.create();
-    conf.set("fs.defaultFS", conf.get(HConstants.HBASE_DIR));
+    Path hbasedir = new Path(conf.get(HConstants.HBASE_DIR));
+    URI defaultFs = hbasedir.getFileSystem(conf).getUri();
+    conf.set("fs.defaultFS", defaultFs.toString());     // for hadoop 0.21+
+    conf.set("fs.default.name", defaultFs.toString());  // for hadoop 0.20
     HBaseFsck fsck = new HBaseFsck(conf);
     long sleepBeforeRerun = DEFAULT_SLEEP_BEFORE_RERUN;
 
diff --git a/src/main/java/org/apache/hadoop/hbase/util/Merge.java b/src/main/java/org/apache/hadoop/hbase/util/Merge.java
index 67d0fda..1ed4225 100644
--- a/src/main/java/org/apache/hadoop/hbase/util/Merge.java
+++ b/src/main/java/org/apache/hadoop/hbase/util/Merge.java
@@ -373,8 +373,12 @@ public class Merge extends Configured implements Tool {
   }
 
   private void usage() {
-    System.err.println(
-        "Usage: bin/hbase merge <table-name> <region-1> <region-2>\n");
+    System.err
+        .println("For hadoop 0.20,  Usage: bin/hbase org.apache.hadoop.hbase.util.Merge "
+            + "[-Dfs.default.name=hdfs://nn:port] <table-name> <region-1> <region-2>\n");
+    System.err
+        .println("For hadoop 0.21+, Usage: bin/hbase org.apache.hadoop.hbase.util.Merge "
+            + "[-Dfs.defaultFS=hdfs://nn:port] <table-name> <region-1> <region-2>\n");
   }
 
   public static void main(String[] args) {
-- 
1.7.0.4

