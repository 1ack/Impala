From 588eb534db02c68ddc86b38825d824f41fa0320c Mon Sep 17 00:00:00 2001
From: Zhihong Yu <tedyu@apache.org>
Date: Mon, 16 Apr 2012 21:59:17 +0000
Subject: [PATCH 018/151] HBASE-5780 Fix race in HBase regionserver startup vs ZK SASL authentication (Shaneal)

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.92@1326815 13f79535-47bb-0310-9956-ffa450edef68

Reason: Low risk bug fix
Author: Shaneal Manek
Ref: CDH-4989
---
 .../hbase/zookeeper/ZooKeeperNodeTracker.java      |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java b/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java
index 19dcffe..1fcd050 100644
--- a/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java
+++ b/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java
@@ -71,6 +71,12 @@ public abstract class ZooKeeperNodeTracker extends ZooKeeperListener {
    * or {@link #getData(boolean)} to get the data of the node if it is available.
    */
   public synchronized void start() {
+    try {
+      ZKUtil.waitForZKConnectionIfAuthenticating(watcher);
+    } catch (InterruptedException e) {
+      throw new IllegalStateException("ZookeeperNodeTracker on " + this.node 
+          + " interuppted while waiting for SASL Authentication", e);
+    }
     this.watcher.registerListener(this);
     try {
       if(ZKUtil.watchAndCheckExists(watcher, node)) {
-- 
1.7.0.4

