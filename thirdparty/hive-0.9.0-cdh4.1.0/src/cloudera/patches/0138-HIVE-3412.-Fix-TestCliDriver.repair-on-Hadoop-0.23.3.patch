From 733e1e063d321c2cb501717971059ccb29bedc5c Mon Sep 17 00:00:00 2001
From: Carl Steinbach <cws@apache.org>
Date: Tue, 4 Sep 2012 08:04:59 +0000
Subject: [PATCH 138/148] HIVE-3412. Fix TestCliDriver.repair on Hadoop 0.23.3, 3.0.0, and 2.2.0-alpha (Zhenxiao Luo via cws)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1380479 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 09b4974ab158a315c594abe8142890d4f63a5916)
---
 ql/src/test/queries/clientpositive/repair.q        |   17 ++++++-
 .../test/queries/clientpositive/repair_hadoop23.q  |   28 +++++++++++
 ql/src/test/results/clientpositive/repair.q.out    |   28 ++++++++++-
 .../results/clientpositive/repair_hadoop23.q.out   |   49 ++++++++++++++++++++
 4 files changed, 118 insertions(+), 4 deletions(-)
 create mode 100644 ql/src/test/queries/clientpositive/repair_hadoop23.q
 create mode 100644 ql/src/test/results/clientpositive/repair_hadoop23.q.out

diff --git a/src/ql/src/test/queries/clientpositive/repair.q b/src/ql/src/test/queries/clientpositive/repair.q
index 5da6a98..badad32 100644
--- a/src/ql/src/test/queries/clientpositive/repair.q
+++ b/src/ql/src/test/queries/clientpositive/repair.q
@@ -2,10 +2,23 @@
 
 CREATE TABLE repairtable(col STRING) PARTITIONED BY (p1 STRING, p2 STRING);
 
+-- EXCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
 MSCK TABLE repairtable;
 
-dfs -mkdir ../build/ql/test/data/warehouse/repairtable/p1=a/p2=a;
-dfs -mkdir ../build/ql/test/data/warehouse/repairtable/p1=b/p2=a;
+dfs -mkdir -p ../build/ql/test/data/warehouse/repairtable/p1=a/p2=a;
+dfs -mkdir -p ../build/ql/test/data/warehouse/repairtable/p1=b/p2=a;
 
 MSCK TABLE repairtable;
 
diff --git a/src/ql/src/test/queries/clientpositive/repair_hadoop23.q b/src/ql/src/test/queries/clientpositive/repair_hadoop23.q
new file mode 100644
index 0000000..7b8bbf5
--- /dev/null
+++ b/src/ql/src/test/queries/clientpositive/repair_hadoop23.q
@@ -0,0 +1,28 @@
+
+
+CREATE TABLE repairtable(col STRING) PARTITIONED BY (p1 STRING, p2 STRING);
+
+-- INCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
+MSCK TABLE repairtable;
+
+dfs -mkdir ../build/ql/test/data/warehouse/repairtable/p1=a/p2=a;
+dfs -mkdir ../build/ql/test/data/warehouse/repairtable/p1=b/p2=a;
+
+MSCK TABLE repairtable;
+
+MSCK REPAIR TABLE repairtable;
+
+MSCK TABLE repairtable;
+
+
diff --git a/src/ql/src/test/results/clientpositive/repair.q.out b/src/ql/src/test/results/clientpositive/repair.q.out
index a05726a..5d9de61 100644
--- a/src/ql/src/test/results/clientpositive/repair.q.out
+++ b/src/ql/src/test/results/clientpositive/repair.q.out
@@ -3,9 +3,33 @@ PREHOOK: type: CREATETABLE
 POSTHOOK: query: CREATE TABLE repairtable(col STRING) PARTITIONED BY (p1 STRING, p2 STRING)
 POSTHOOK: type: CREATETABLE
 POSTHOOK: Output: default@repairtable
-PREHOOK: query: MSCK TABLE repairtable
+PREHOOK: query: -- EXCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
+MSCK TABLE repairtable
 PREHOOK: type: MSCK
-POSTHOOK: query: MSCK TABLE repairtable
+POSTHOOK: query: -- EXCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
+MSCK TABLE repairtable
 POSTHOOK: type: MSCK
 PREHOOK: query: MSCK TABLE repairtable
 PREHOOK: type: MSCK
diff --git a/src/ql/src/test/results/clientpositive/repair_hadoop23.q.out b/src/ql/src/test/results/clientpositive/repair_hadoop23.q.out
new file mode 100644
index 0000000..0f68b25
--- /dev/null
+++ b/src/ql/src/test/results/clientpositive/repair_hadoop23.q.out
@@ -0,0 +1,49 @@
+PREHOOK: query: CREATE TABLE repairtable(col STRING) PARTITIONED BY (p1 STRING, p2 STRING)
+PREHOOK: type: CREATETABLE
+POSTHOOK: query: CREATE TABLE repairtable(col STRING) PARTITIONED BY (p1 STRING, p2 STRING)
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: default@repairtable
+PREHOOK: query: -- INCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
+MSCK TABLE repairtable
+PREHOOK: type: MSCK
+POSTHOOK: query: -- INCLUDE_HADOOP_MAJOR_VERSIONS(0.20, 0.23)
+-- When you invoke the mkdir command using versions of Hadoop up to and including 0.23,
+-- they behave as if you had specified the -p option,
+-- *but* they don't actually support the -p option.
+
+-- Support for the -p option first appeared in 1.0 and 2.0,
+-- but they maintain backward compatibility with older versions,
+-- so they let you include -p, but if you don't they still act like you did.
+
+-- HADOOP-8551 breaks backward compatibility with 0.23 and older versions by
+-- requiring you to explicitly specify -p if you require that behavior.
+
+MSCK TABLE repairtable
+POSTHOOK: type: MSCK
+PREHOOK: query: MSCK TABLE repairtable
+PREHOOK: type: MSCK
+POSTHOOK: query: MSCK TABLE repairtable
+POSTHOOK: type: MSCK
+Partitions not in metastore:	repairtable:p1=a/p2=a	repairtable:p1=b/p2=a
+PREHOOK: query: MSCK REPAIR TABLE repairtable
+PREHOOK: type: MSCK
+POSTHOOK: query: MSCK REPAIR TABLE repairtable
+POSTHOOK: type: MSCK
+Partitions not in metastore:	repairtable:p1=a/p2=a	repairtable:p1=b/p2=a
+Repair: Added partition to metastore repairtable:p1=a/p2=a
+Repair: Added partition to metastore repairtable:p1=b/p2=a
+PREHOOK: query: MSCK TABLE repairtable
+PREHOOK: type: MSCK
+POSTHOOK: query: MSCK TABLE repairtable
+POSTHOOK: type: MSCK
-- 
1.7.0.4

