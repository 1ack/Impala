From 1241a5a1768835ccccbcad997b773141ca9b9792 Mon Sep 17 00:00:00 2001
From: Ashutosh Chauhan <hashutosh@apache.org>
Date: Thu, 31 May 2012 16:14:26 +0000
Subject: [PATCH 071/144] HIVE-3052 : TestHadoop20SAuthBridge always uses the same port (Navis via Ashutosh Chauhan)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1344797 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 1ba8d2e6ac807bf988c46a21f5c573b49ff0a96a)
---
 .../hive/thrift/TestHadoop20SAuthBridge.java       |   15 ++++++++++++---
 1 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java b/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
index af84b40..b96894b 100644
--- a/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
+++ b/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
@@ -23,6 +23,7 @@ import java.io.DataInputStream;
 import java.io.IOException;
 import java.net.InetAddress;
 import java.net.NetworkInterface;
+import java.net.ServerSocket;
 import java.security.PrivilegedExceptionAction;
 import java.util.ArrayList;
 import java.util.Arrays;
@@ -117,7 +118,8 @@ public class TestHadoop20SAuthBridge extends TestCase {
         builder.toString());
   }
 
-  public void setup(final int port) throws Exception {
+  public void setup() throws Exception {
+    int port = findFreePort();
     System.setProperty(HiveConf.ConfVars.METASTORE_USE_THRIFT_SASL.varname,
         "true");
     System.setProperty(HiveConf.ConfVars.METASTOREURIS.varname,
@@ -207,14 +209,14 @@ public class TestHadoop20SAuthBridge extends TestCase {
   }
 
   public void testSaslWithHiveMetaStore() throws Exception {
-    setup(10000);
+    setup();
     UserGroupInformation clientUgi = UserGroupInformation.getCurrentUser();
     obtainTokenAndAddIntoUGI(clientUgi, null);
     obtainTokenAndAddIntoUGI(clientUgi, "tokenForFooTablePartition");
   }
 
   public void testMetastoreProxyUser() throws Exception {
-    setup(10010);
+    setup();
 
     final String proxyUserName = "proxyUser";
     //set the configuration up such that proxyUser can act on
@@ -374,4 +376,11 @@ public class TestHadoop20SAuthBridge extends TestCase {
     client.dropDatabase(dbName);
     assertTrue("Databases do not match", db1.getName().equals(db.getName()));
   }
+
+  private int findFreePort() throws IOException {
+    ServerSocket socket= new ServerSocket(0);
+    int port = socket.getLocalPort();
+    socket.close();
+    return port;
+  }
 }
-- 
1.7.0.4

