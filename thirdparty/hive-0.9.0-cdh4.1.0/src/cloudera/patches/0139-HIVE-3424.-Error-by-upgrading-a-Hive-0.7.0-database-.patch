From 1cafd0d7513d32b30a8d478b9be49293fe21a2ba Mon Sep 17 00:00:00 2001
From: Carl Steinbach <cws@apache.org>
Date: Tue, 4 Sep 2012 08:26:05 +0000
Subject: [PATCH 139/144] HIVE-3424. Error by upgrading a Hive 0.7.0 database to 0.8.0 (008-HIVE-2246.mysql.sql) (Alexander Alten-Lorenz via cws)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1380483 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 20b7cf85f132450724f3ca1bee643b1c1db933af)
---
 .../scripts/upgrade/mysql/008-HIVE-2246.mysql.sql  |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/src/metastore/scripts/upgrade/mysql/008-HIVE-2246.mysql.sql b/src/metastore/scripts/upgrade/mysql/008-HIVE-2246.mysql.sql
index 3ac8d2e..d8f2087 100644
--- a/src/metastore/scripts/upgrade/mysql/008-HIVE-2246.mysql.sql
+++ b/src/metastore/scripts/upgrade/mysql/008-HIVE-2246.mysql.sql
@@ -26,9 +26,11 @@ CREATE PROCEDURE REVERT()
     DROP TABLE IF EXISTS COLUMNS_V2;
     DROP TABLE IF EXISTS TABLE_SDS;
     DROP TABLE IF EXISTS CDS;
+    SET FOREIGN_KEY_CHECKS = 0;
     ALTER TABLE COLUMNS_OLD 
       ADD CONSTRAINT `COLUMNS_FK1` FOREIGN KEY (`SD_ID`) REFERENCES `SDS`(`SD_ID`)
     ;
+    SET FOREIGN_KEY_CHECKS = 1;	
     RENAME TABLE COLUMNS_OLD TO COLUMNS;
 
   END $$
@@ -214,8 +216,10 @@ CREATE PROCEDURE CREATE_TABLE_SDS()
 CREATE PROCEDURE RENAME_OLD_COLUMNS()
   BEGIN
     RENAME TABLE `COLUMNS` TO `COLUMNS_OLD`;
+    SET FOREIGN_KEY_CHECKS = 0;	
     ALTER TABLE COLUMNS_OLD 
       DROP FOREIGN KEY `COLUMNS_FK1`;
+    SET FOREIGN_KEY_CHECKS = 1;
   END $$
 
 /*
-- 
1.7.0.4

