From d656fb85b2dcadb2d3cf76d7853be97abb5309a5 Mon Sep 17 00:00:00 2001
From: Edward Capriolo <ecapriolo@apache.org>
Date: Fri, 22 Jun 2012 22:11:23 +0000
Subject: [PATCH 103/144] HIVE-3128 Use commons-compress instead of forking tar process (Kanna Karanam via egc)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1353044 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 7d3b6dbfcf53f52e6dc15cb8c689072657edd6c9)
---
 common/ivy.xml                                     |    1 +
 .../org/apache/hadoop/hive/common/FileUtils.java   |   44 +++++++++++++-------
 ivy/libraries.properties                           |    1 +
 3 files changed, 31 insertions(+), 15 deletions(-)

diff --git a/src/common/ivy.xml b/src/common/ivy.xml
index afc61d7..8a1f95c 100644
--- a/src/common/ivy.xml
+++ b/src/common/ivy.xml
@@ -84,6 +84,7 @@
     <dependency org="org.apache.hive" name="hive-shims" rev="${version}"
                 conf="compile->default" transitive="false" />
     <dependency org="commons-cli" name="commons-cli" rev="${commons-cli.version}"/>
+    <dependency org="org.apache.commons" name="commons-compress" rev="${commons-compress.version}"/>
     <dependency org="commons-lang" name="commons-lang" rev="${commons-lang.version}"/>
     <dependency org="commons-logging" name="commons-logging" rev="${commons-logging.version}"
                 transitive="false"/>
diff --git a/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java b/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
index 3ca3d29..3f2b56a 100644
--- a/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
+++ b/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
@@ -18,16 +18,23 @@
 
 package org.apache.hadoop.hive.common;
 
+import java.io.BufferedOutputStream;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileOutputStream;
 import java.io.IOException;
 import java.net.URI;
 import java.util.BitSet;
 import java.util.List;
 
+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;
+import org.apache.commons.compress.archivers.tar.TarArchiveOutputStream;
+import org.apache.commons.compress.compressors.gzip.GzipCompressorOutputStream;
+import org.apache.commons.compress.utils.IOUtils;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileStatus;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
-import org.apache.hadoop.util.Shell.ShellCommandExecutor;
 
 /**
  * Collection of file manipulation utilities common across Hive.
@@ -248,20 +255,27 @@ public final class FileUtils {
    */
   public static void tar(String parentDir, String[] inputFiles, String outputFile)
       throws IOException {
-    StringBuffer tarCommand = new StringBuffer();
-    tarCommand.append("cd " + parentDir + " ; ");
-    tarCommand.append(" tar -zcvf ");
-    tarCommand.append(" " + outputFile);
-    for (int i = 0; i < inputFiles.length; i++) {
-      tarCommand.append(" " + inputFiles[i]);
-    }
-    String[] shellCmd = {"bash", "-c", tarCommand.toString()};
-    ShellCommandExecutor shexec = new ShellCommandExecutor(shellCmd);
-    shexec.execute();
-    int exitcode = shexec.getExitCode();
-    if (exitcode != 0) {
-      throw new IOException("Error tarring file " + outputFile
-          + ". Tar process exited with exit code " + exitcode);
+    TarArchiveOutputStream tOut = null;
+
+    try {
+      tOut = new TarArchiveOutputStream(
+          new GzipCompressorOutputStream(
+              new BufferedOutputStream(
+                  new FileOutputStream(new File(parentDir, outputFile)))));
+
+      for (int i = 0; i < inputFiles.length; i++) {
+        File f = new File(inputFiles[i]);
+        TarArchiveEntry tarEntry = new TarArchiveEntry(f, f.getName());
+        tOut.setLongFileMode(TarArchiveOutputStream.LONGFILE_GNU);
+        tOut.putArchiveEntry(tarEntry);
+        IOUtils.copy(new FileInputStream(f), tOut);
+        tOut.closeArchiveEntry();
+      }
+    } finally {
+      if(tOut != null ) {
+        tOut.finish();
+        tOut.close();
+      }
     }
   }
 }
diff --git a/src/ivy/libraries.properties b/src/ivy/libraries.properties
index 13e6f29..246310d 100644
--- a/src/ivy/libraries.properties
+++ b/src/ivy/libraries.properties
@@ -32,6 +32,7 @@ checkstyle.version=5.0
 commons-cli.version=1.2
 commons-codec.version=1.4
 commons-collections.version=3.2.1
+commons-compress.version=1.4.1
 commons-configuration.version=1.6
 commons-dbcp.version=1.4
 commons-httpclient.version=3.0.1
-- 
1.7.0.4

