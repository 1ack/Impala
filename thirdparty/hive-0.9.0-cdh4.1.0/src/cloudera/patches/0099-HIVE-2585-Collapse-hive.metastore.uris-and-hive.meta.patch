From 15576ce2385736baef5283d9173d8a91460dbede Mon Sep 17 00:00:00 2001
From: Edward Capriolo <ecapriolo@apache.org>
Date: Wed, 20 Jun 2012 21:26:00 +0000
Subject: [PATCH 099/148] HIVE-2585 Collapse hive.metastore.uris and hive.metastore.local (Ashutosh Chauhan via egc)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1352333 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 11015a25391c7110977a419c75dc27f4404296ad)
---
 .../java/org/apache/hadoop/hive/conf/HiveConf.java |   15 +++++++++++++--
 conf/hive-default.xml.template                     |    6 +++---
 data/conf/hive-site.xml                            |    6 ------
 .../hadoop/hive/metastore/HiveMetaStoreClient.java |    3 ++-
 .../hive/metastore/TestMarkPartitionRemote.java    |    2 --
 .../hive/metastore/TestMetaStoreAuthorization.java |    1 -
 .../hive/metastore/TestMetaStoreEventListener.java |    1 -
 .../hive/metastore/TestRemoteHiveMetaStore.java    |    1 -
 .../TestRemoteHiveMetaStoreIpAddress.java          |    1 -
 .../hive/thrift/TestHadoop20SAuthBridge.java       |    1 -
 10 files changed, 18 insertions(+), 19 deletions(-)

diff --git a/src/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java b/src/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
index 89d778d..57f4f74 100644
--- a/src/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
+++ b/src/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
@@ -82,7 +82,6 @@ public class HiveConf extends Configuration {
       HiveConf.ConfVars.METASTOREDIRECTORY,
       HiveConf.ConfVars.METASTOREWAREHOUSE,
       HiveConf.ConfVars.METASTOREURIS,
-      HiveConf.ConfVars.METASTORE_MODE,
       HiveConf.ConfVars.METASTORETHRIFTRETRIES,
       HiveConf.ConfVars.METASTORE_CLIENT_CONNECT_RETRY_DELAY,
       HiveConf.ConfVars.METASTORE_CLIENT_SOCKET_TIMEOUT,
@@ -301,7 +300,6 @@ public class HiveConf extends Configuration {
     METASTORE_EVENT_EXPIRY_DURATION("hive.metastore.event.expiry.duration",0L),
     METASTORE_EXECUTE_SET_UGI("hive.metastore.execute.setugi", false),
 
-    METASTORE_MODE("hive.metastore.local",true),
     // Default parameters for creating tables
     NEWTABLEDEFAULTPARA("hive.table.parameters.default", ""),
     METASTORE_RAW_STORE_IMPL("hive.metastore.rawstore.impl",
@@ -867,6 +865,19 @@ public class HiveConf extends Configuration {
     // Overlay the values of any system properties whose names appear in the list of ConfVars
     applySystemProperties();
 
+    if(this.get("hive.metastore.local", null) != null) {
+      l4j.warn("DEPRECATED: Configuration property hive.metastore.local no longer has any " +
+      		"effect. Make sure to provide a valid value for hive.metastore.uris if you are " +
+      		"connecting to a remote metastore.");
+    }
+
+    if (null != this.get(ConfVars.METASTOREURIS.varname, null) &&
+        null != this.get(ConfVars.METASTORECONNECTURLKEY.varname, null)) {
+      l4j.error("Found both " + ConfVars.METASTOREURIS.varname + " and " +
+        ConfVars.METASTORECONNECTURLKEY + " Recommended to have exactly one of those config key" +
+        "in configuration");
+    }
+
     // if the running class was loaded directly (through eclipse) rather than through a
     // jar then this would be needed
     if (hiveJar == null) {
diff --git a/src/conf/hive-default.xml.template b/src/conf/hive-default.xml.template
index a1eac7c..b64d830 100644
--- a/src/conf/hive-default.xml.template
+++ b/src/conf/hive-default.xml.template
@@ -100,9 +100,9 @@
 </property>
 
 <property>
-  <name>hive.metastore.local</name>
-  <value>true</value>
-  <description>controls whether to connect to remove metastore server or open a new metastore server in Hive Client JVM</description>
+  <name>hive.metastore.uris</name>
+  <value></value>
+  <description>Thrift uri for the remote metastore. Used by metastore client to connect to remote metastore.</description>
 </property>
 
 <property>
diff --git a/src/data/conf/hive-site.xml b/src/data/conf/hive-site.xml
index 55c880c..f279f5a 100644
--- a/src/data/conf/hive-site.xml
+++ b/src/data/conf/hive-site.xml
@@ -68,12 +68,6 @@
 </property>
 
 <property>
-  <name>hive.metastore.local</name>
-  <value>true</value>
-  <description>controls whether to connect to remove metastore server or open a new metastore server in Hive Client JVM</description>
-</property>
-
-<property>
   <!--  this should eventually be deprecated since the metastore should supply this -->
   <name>hive.metastore.warehouse.dir</name>
   <value>${test.warehouse.dir}</value>
diff --git a/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java b/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java
index 48fe1be..4367f7a 100644
--- a/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java
+++ b/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java
@@ -108,7 +108,8 @@ public class HiveMetaStoreClient implements IMetaStoreClient {
     }
     this.conf = conf;
 
-    localMetaStore = conf.getBoolVar(ConfVars.METASTORE_MODE);
+    String msUri = conf.getVar(HiveConf.ConfVars.METASTOREURIS);
+    localMetaStore = (msUri == null) ? true : msUri.trim().isEmpty();
     if (localMetaStore) {
       // instantiate the metastore server handler directly instead of connecting
       // through the network
diff --git a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMarkPartitionRemote.java b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMarkPartitionRemote.java
index dad795c..0bbaafb 100644
--- a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMarkPartitionRemote.java
+++ b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMarkPartitionRemote.java
@@ -19,7 +19,6 @@
 package org.apache.hadoop.hive.metastore;
 
 import org.apache.hadoop.hive.conf.HiveConf;
-import org.apache.hadoop.hive.conf.HiveConf.ConfVars;
 
 public class TestMarkPartitionRemote extends TestMarkPartition{
 
@@ -42,7 +41,6 @@ public class TestMarkPartitionRemote extends TestMarkPartition{
     Thread t = new Thread(new RunMS());
     t.setDaemon(true);
     t.start();
-    hiveConf.setBoolVar(ConfVars.METASTORE_MODE, false);
     hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS, "thrift://localhost:29111");
     hiveConf.setIntVar(HiveConf.ConfVars.METASTORETHRIFTRETRIES, 3);
     Thread.sleep(30000);
diff --git a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreAuthorization.java b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreAuthorization.java
index a089269..3019c41 100644
--- a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreAuthorization.java
+++ b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreAuthorization.java
@@ -39,7 +39,6 @@ public class TestMetaStoreAuthorization extends TestCase {
   public void setup() throws Exception {
     System.setProperty(HiveConf.ConfVars.METASTORE_AUTHORIZATION_STORAGE_AUTH_CHECKS.varname,
         "true");
-    conf.setBoolVar(ConfVars.METASTORE_MODE, false);
     conf.setVar(HiveConf.ConfVars.METASTOREURIS, "thrift://localhost:" + port);
     conf.setIntVar(HiveConf.ConfVars.METASTORETHRIFTRETRIES, 3);
     conf.setIntVar(ConfVars.METASTORE_CLIENT_CONNECT_RETRY_DELAY, 60);
diff --git a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreEventListener.java b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreEventListener.java
index 736dc35..4ff9eb9 100644
--- a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreEventListener.java
+++ b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestMetaStoreEventListener.java
@@ -90,7 +90,6 @@ public class TestMetaStoreEventListener extends TestCase {
     t.start();
     Thread.sleep(40000);
     hiveConf = new HiveConf(this.getClass());
-    hiveConf.setBoolVar(ConfVars.METASTORE_MODE, false);
     hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS, "thrift://localhost:" + msPort);
     hiveConf.setIntVar(HiveConf.ConfVars.METASTORETHRIFTRETRIES, 3);
     hiveConf.set(HiveConf.ConfVars.PREEXECHOOKS.varname, "");
diff --git a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStore.java b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStore.java
index 6076bef..ce4fa6f 100644
--- a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStore.java
+++ b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStore.java
@@ -67,7 +67,6 @@ public class TestRemoteHiveMetaStore extends TestHiveMetaStore {
   }
 
   protected void createClient(boolean setugi) throws Exception {
-    hiveConf.setBoolVar(ConfVars.METASTORE_MODE, false);
     hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS, "thrift://localhost:" + METASTORE_PORT);
     hiveConf.setBoolVar(ConfVars.METASTORE_EXECUTE_SET_UGI,setugi);
     client = new HiveMetaStoreClient(hiveConf);
diff --git a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStoreIpAddress.java b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStoreIpAddress.java
index be656f7..425d32e 100644
--- a/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStoreIpAddress.java
+++ b/src/metastore/src/test/org/apache/hadoop/hive/metastore/TestRemoteHiveMetaStoreIpAddress.java
@@ -101,7 +101,6 @@ public class TestRemoteHiveMetaStoreIpAddress extends TestCase {
   }
 
   protected void createClient() throws Exception {
-    hiveConf.setBoolVar(ConfVars.METASTORE_MODE, false);
     hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS, "thrift://localhost:" + port);
     msc = new HiveMetaStoreClient(hiveConf);
   }
diff --git a/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java b/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
index b96894b..2c196bb 100644
--- a/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
+++ b/src/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
@@ -127,7 +127,6 @@ public class TestHadoop20SAuthBridge extends TestCase {
     System.setProperty(HiveConf.ConfVars.METASTOREWAREHOUSE.varname, new Path(
         System.getProperty("test.build.data", "/tmp")).toString());
     conf = new HiveConf(TestHadoop20SAuthBridge.class);
-    conf.setBoolVar(ConfVars.METASTORE_MODE, false);
     MetaStoreUtils.startMetaStore(port, new MyHadoopThriftAuthBridge20S());
   }
 
-- 
1.7.0.4

