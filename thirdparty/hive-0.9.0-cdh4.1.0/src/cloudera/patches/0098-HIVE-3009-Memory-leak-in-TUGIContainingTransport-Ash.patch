From 299d4c5acec5b242a30d67b6168db9c1a35bfdc7 Mon Sep 17 00:00:00 2001
From: Edward Capriolo <ecapriolo@apache.org>
Date: Wed, 20 Jun 2012 18:41:16 +0000
Subject: [PATCH 098/144] HIVE-3009 Memory leak in TUGIContainingTransport (Ashutosh Chauhan via egc)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1352260 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 40eff1037813f22b89f146a7253b39ade1e6b7bb)
---
 .../hive/thrift/TUGIContainingTransport.java       |   11 ++++++-----
 1 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/src/shims/src/common/java/org/apache/hadoop/hive/thrift/TUGIContainingTransport.java b/src/shims/src/common/java/org/apache/hadoop/hive/thrift/TUGIContainingTransport.java
index da0f79f..d73d77b 100644
--- a/src/shims/src/common/java/org/apache/hadoop/hive/thrift/TUGIContainingTransport.java
+++ b/src/shims/src/common/java/org/apache/hadoop/hive/thrift/TUGIContainingTransport.java
@@ -36,7 +36,7 @@ public class TUGIContainingTransport extends TFilterTransport {
 
   private UserGroupInformation ugi;
 
-  public TUGIContainingTransport(TTransport wrapped, UserGroupInformation ugi) {
+  public TUGIContainingTransport(TTransport wrapped) {
     super(wrapped);
   }
 
@@ -65,9 +65,10 @@ public class TUGIContainingTransport extends TFilterTransport {
 
   public static class Factory extends TTransportFactory {
 
-    // Need a concurrent weak hashmap.
+    // Need a concurrent weakhashmap. WeakKeys() so that when underlying transport gets out of
+    // scope, it still can be GC'ed. Since value of map has a ref to key, need weekValues as well.
     private static final ConcurrentMap<TTransport, TUGIContainingTransport> transMap =
-        new MapMaker().weakKeys().makeMap();
+        new MapMaker().weakKeys().weakValues().makeMap();
 
     /**
      * Get a new <code>TUGIContainingTransport</code> instance, or reuse the
@@ -81,8 +82,8 @@ public class TUGIContainingTransport extends TFilterTransport {
 
       // UGI information is not available at connection setup time, it will be set later
       // via set_ugi() rpc.
-      transMap.putIfAbsent(trans, new TUGIContainingTransport(trans,null));
+      transMap.putIfAbsent(trans, new TUGIContainingTransport(trans));
       return transMap.get(trans);
     }
   }
-}
\ No newline at end of file
+}
-- 
1.7.0.4

