From ec033f62ea6630d45f4e1b93108fb2a43056ce02 Mon Sep 17 00:00:00 2001
From: Kevin Wilfong <kevinwilfong@apache.org>
Date: Wed, 9 May 2012 16:31:39 +0000
Subject: [PATCH 054/144] HIVE-2956 Provide error message when using UDAF in the place of UDF instead of throwing NPE (navis via kevinwilfong)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1336284 13f79535-47bb-0310-9956-ffa450edef68
(cherry picked from commit 50f7f66f8665b3480a2da3365b4c1c8c85d6c4b8)
---
 .../org/apache/hadoop/hive/ql/parse/ErrorMsg.java  |    1 +
 .../hadoop/hive/ql/parse/TypeCheckProcFactory.java |    9 +++++++++
 .../queries/clientnegative/udaf_invalid_place.q    |    1 +
 .../queries/clientnegative/udtf_invalid_place.q    |    1 +
 .../clientnegative/udaf_invalid_place.q.out        |    1 +
 .../clientnegative/udtf_invalid_place.q.out        |    1 +
 6 files changed, 14 insertions(+), 0 deletions(-)
 create mode 100644 ql/src/test/queries/clientnegative/udaf_invalid_place.q
 create mode 100644 ql/src/test/queries/clientnegative/udtf_invalid_place.q
 create mode 100644 ql/src/test/results/clientnegative/udaf_invalid_place.q.out
 create mode 100644 ql/src/test/results/clientnegative/udtf_invalid_place.q.out

diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java
index 04f080d..9815b57 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java
@@ -130,6 +130,7 @@ public enum ErrorMsg {
   UDTF_NO_DISTRIBUTE_BY("DISTRUBTE BY is not supported with a UDTF in the SELECT clause"),
   UDTF_INVALID_LOCATION("UDTF's are not supported outside the SELECT clause, nor nested "
       + "in expressions"),
+  UDAF_INVALID_LOCATION("Not yet supported place for UDAF"),
   UDTF_LATERAL_VIEW("UDTF's cannot be in a select expression when there is a lateral view"),
   UDTF_ALIAS_MISMATCH("The number of aliases supplied in the AS clause does not match the "
       + "number of columns output by the UDTF"),
diff --git a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
index 21a3205..81dd807 100644
--- a/src/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
+++ b/src/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
@@ -684,6 +684,15 @@ public final class TypeCheckProcFactory {
         if (fi.getGenericUDTF() != null) {
           throw new SemanticException(ErrorMsg.UDTF_INVALID_LOCATION.getMsg());
         }
+        // UDAF in filter condition, group-by caluse, param of funtion, etc.
+        if (fi.getGenericUDAFResolver() != null) {
+          if (isFunction) {
+            throw new SemanticException(ErrorMsg.UDAF_INVALID_LOCATION.
+                getMsg((ASTNode) expr.getChild(0)));
+          } else {
+            throw new SemanticException(ErrorMsg.UDAF_INVALID_LOCATION.getMsg(expr));
+          }
+        }
         if (!ctx.getAllowStatefulFunctions() && (fi.getGenericUDF() != null)) {
           if (FunctionRegistry.isStateful(fi.getGenericUDF())) {
             throw new SemanticException(
diff --git a/src/ql/src/test/queries/clientnegative/udaf_invalid_place.q b/src/ql/src/test/queries/clientnegative/udaf_invalid_place.q
new file mode 100644
index 0000000..f37ce72
--- /dev/null
+++ b/src/ql/src/test/queries/clientnegative/udaf_invalid_place.q
@@ -0,0 +1 @@
+select distinct key, sum(key) from src;
diff --git a/src/ql/src/test/queries/clientnegative/udtf_invalid_place.q b/src/ql/src/test/queries/clientnegative/udtf_invalid_place.q
new file mode 100644
index 0000000..ab84a80
--- /dev/null
+++ b/src/ql/src/test/queries/clientnegative/udtf_invalid_place.q
@@ -0,0 +1 @@
+select distinct key, explode(key) from src;
diff --git a/src/ql/src/test/results/clientnegative/udaf_invalid_place.q.out b/src/ql/src/test/results/clientnegative/udaf_invalid_place.q.out
new file mode 100644
index 0000000..f663f4d
--- /dev/null
+++ b/src/ql/src/test/results/clientnegative/udaf_invalid_place.q.out
@@ -0,0 +1 @@
+FAILED: Error in semantic analysis: Line 1:21 Not yet supported place for UDAF 'sum'
diff --git a/src/ql/src/test/results/clientnegative/udtf_invalid_place.q.out b/src/ql/src/test/results/clientnegative/udtf_invalid_place.q.out
new file mode 100644
index 0000000..90d498b
--- /dev/null
+++ b/src/ql/src/test/results/clientnegative/udtf_invalid_place.q.out
@@ -0,0 +1 @@
+FAILED: Error in semantic analysis: UDTF's are not supported outside the SELECT clause, nor nested in expressions
-- 
1.7.0.4

