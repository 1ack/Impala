From 089a5c30831067a99b6334480fdf9d0a02e6e621 Mon Sep 17 00:00:00 2001
From: Carl Steinbach <carl@cloudera.com>
Date: Mon, 6 Feb 2012 19:06:15 -0800
Subject: [PATCH 24/58] CDH-4197. RCFile BlockMergeTask triggers IOE in o.a.h.mapreduce.Cluster.initialize()

Reason: Bug
Author: Carl Steinbach
Ref: CDH-4197
---
 build-common.xml        |   26 ++++++++++++++++----------
 contrib/build.xml       |   10 +---------
 hbase-handler/build.xml |    3 +--
 hwi/build.xml           |    9 +--------
 jdbc/build.xml          |    9 +--------
 odbc/build.xml          |    1 +
 ql/build.xml            |   15 +--------------
 service/build.xml       |    7 +------
 8 files changed, 23 insertions(+), 57 deletions(-)

diff --git a/src/build-common.xml b/src/build-common.xml
index d59d5df..26bc7be 100644
--- a/src/build-common.xml
+++ b/src/build-common.xml
@@ -91,23 +91,29 @@
   <property name="hadoopVersion" value="${hadoop.version.ant-internal}"/>
   <property name="test.serialize.qplan" value="false"/>
 
+  <path id="hadoop-23.test.classpath">
+    <fileset dir="${hadoop.root}">
+      <include name="share/hadoop/common/*.jar"/>
+      <include name="share/hadoop/common/lib/*.jar"/>
+      <include name="share/hadoop/hdfs/*.jar"/>
+      <include name="share/hadoop/hdfs/lib/*.jar"/>
+      <include name="share/hadoop/mapreduce/*.jar"/>
+      <include name="share/hadoop/mapreduce/lib/*.jar"/>
+      <include name="share/hadoop/tools/*.jar"/>
+      <include name="share/hadoop/tools/lib/*.jar"/>
+    </fileset>
+    <!-- Hack to get jobclient test jar in classpath. -->
+    <fileset dir="${hive.root}/build/ivy/lib" includes="test/hadoop-mapreduce-client-jobclient-*-tests.jar" />
+  </path>
+  
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${test.build.classes}" />
     <pathelement location="${test.build.resources}" />
     <pathelement location="" />
     <pathelement location="${test.src.data.dir}/conf"/>
     <pathelement location="${hive.conf.dir}"/>
-    <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
     <path refid="classpath"/>
-    <fileset dir="${hadoop.root}">
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <include name="share/hadoop/tools/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
-    <!-- Hack to get jobclient test jar in classpath. -->
-    <fileset dir="${hive.root}/build/ivy/lib" includes="test/hadoop-mapreduce-client-jobclient-*-tests.jar" />
   </path>
 
 
diff --git a/src/contrib/build.xml b/src/contrib/build.xml
index 230374f..d4a9a14 100644
--- a/src/contrib/build.xml
+++ b/src/contrib/build.xml
@@ -29,6 +29,7 @@
   <import file="../build-common.xml"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${build.dir.hive}/ql/test/classes" />
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
@@ -42,15 +43,6 @@
     <pathelement location="${jasperc.test.jar}"/>
     <pathelement location="${jsp.test.jar}"/>
     <pathelement location="${common.jar}"/>
-    <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
-    <fileset dir="${hadoop.root}">
-      <include name="lib/**/*.jar" />
-      <exclude name="lib/**/excluded/" />
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
     <path refid="classpath"/>
   </path>
 
diff --git a/src/hbase-handler/build.xml b/src/hbase-handler/build.xml
index 98dcce9..ba7ca77 100644
--- a/src/hbase-handler/build.xml
+++ b/src/hbase-handler/build.xml
@@ -30,6 +30,7 @@
   <import file="../build-common.xml"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${build.dir.hive}/ql/test/classes" />
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
@@ -49,8 +50,6 @@
     <pathelement location="${jsp.test.jar}"/>
     <pathelement location="${common.jar}"/>
     <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
-    <fileset dir="${hadoop.root}/lib" includes="*.jar"/>
-    <fileset dir="${hadoop.root}/lib" includes="jsp-2.1/*.jar"/>
     <path refid="classpath"/>
   </path>
 
diff --git a/src/hwi/build.xml b/src/hwi/build.xml
index 7e4fd4e..9354579 100644
--- a/src/hwi/build.xml
+++ b/src/hwi/build.xml
@@ -26,14 +26,7 @@
        Hive classpath. Some HWI components are linked
        to the servlet libraries.  -->
   <path id="classpath-hwi">
-    <fileset dir="${hadoop.root}">
-      <include name="lib/**/*.jar" />
-      <exclude name="lib/**/excluded/" />
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
+    <path refid="hadoop-23.test.classpath"/>
     <path refid="classpath"/>
   </path>
 
diff --git a/src/jdbc/build.xml b/src/jdbc/build.xml
index ea720a4..b456dab 100644
--- a/src/jdbc/build.xml
+++ b/src/jdbc/build.xml
@@ -30,6 +30,7 @@
   <import file="../build-common.xml"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
     <pathelement location="${test.src.data.dir}/conf"/>
@@ -37,14 +38,6 @@
     <fileset dir="${test.src.data.dir}" includes="files/*.jar"/>
     <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
     <pathelement location="${build.dir.hive}/ql/test/classes"/>
-    <fileset dir="${hadoop.root}">
-      <include name="lib/**/*.jar" />
-      <exclude name="lib/**/excluded/" />
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
     <path refid="classpath"/>
   </path>
 
diff --git a/src/odbc/build.xml b/src/odbc/build.xml
index cddbba4..f9bff43 100644
--- a/src/odbc/build.xml
+++ b/src/odbc/build.xml
@@ -30,6 +30,7 @@
   <import file="../build-common.xml"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
     <pathelement location="${test.src.data.dir}/conf"/>
diff --git a/src/ql/build.xml b/src/ql/build.xml
index 456c1e2..6e016b9 100644
--- a/src/ql/build.xml
+++ b/src/ql/build.xml
@@ -33,6 +33,7 @@
   <property name="ql.test.clientpositive.exclude" value="${minimr.query.files}"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
     <pathelement location="${hadoop.conf.dir}"/>
@@ -50,21 +51,7 @@
     <pathelement location="${jsp.test.jar}"/>
     <pathelement location="${common.jar}"/>
     <pathelement location="${hive.root}/build/ivy/lib/default/derby-${derby.version}.jar"/>
-    <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
-    <fileset dir="${hadoop.root}">
-      <include name="lib/**/*.jar" />
-      <exclude name="lib/**/excluded/" />
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <include name="share/hadoop/tools/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
-
     <path refid="classpath"/>
-    <!-- Hack to get jobclient test jar in classpath. -->
-    <fileset dir="${hive.root}/build/ivy/lib/test" includes="hadoop-mapreduce-client-jobclient-*-tests.jar" />
-
   </path>
 
   <target name="thriftif" depends="check-thrift-home">
diff --git a/src/service/build.xml b/src/service/build.xml
index d837091..b8c768b 100644
--- a/src/service/build.xml
+++ b/src/service/build.xml
@@ -23,6 +23,7 @@
   <import file="../build-common.xml"/>
 
   <path id="test.classpath">
+    <path refid="hadoop-23.test.classpath"/>
     <pathelement location="${test.build.classes}" />
     <pathelement location="" />
     <pathelement location="${test.src.data.dir}/conf"/>
@@ -31,12 +32,6 @@
     <fileset dir="${hive.root}" includes="testlibs/*.jar"/>
     <pathelement location="${build.dir.hive}/ql/test/classes"/>
     <path refid="classpath"/>
-    <fileset dir="${hadoop.root}">
-      <!-- below is for 0.23 onwards -->
-      <include name="share/hadoop/common/lib/*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-mapreduce-*.jar" />
-      <exclude name="share/hadoop/common/lib/hadoop-yarn-*.jar" />
-    </fileset>
   </path>
 
   <target name="thriftif" depends="check-thrift-home">
-- 
1.7.0.4

