From 90a570bdd7cfb86c4c71c4bdcb590abe89d80f4a Mon Sep 17 00:00:00 2001
From: Carl Steinbach <carl@cloudera.com>
Date: Mon, 2 Apr 2012 14:45:12 -0700
Subject: [PATCH 46/58] HIVE-2920. TestStatsPublisherEnhanced throws NPE on JDBC connection failure

Reason: Bug
Author: Carl Steinbach
Ref: CDH-5120
---
 .../hive/ql/exec/TestStatsPublisherEnhanced.java   |   21 ++++++++++---------
 1 files changed, 11 insertions(+), 10 deletions(-)

diff --git a/src/ql/src/test/org/apache/hadoop/hive/ql/exec/TestStatsPublisherEnhanced.java b/src/ql/src/test/org/apache/hadoop/hive/ql/exec/TestStatsPublisherEnhanced.java
index def55d9..6c25d4c 100644
--- a/src/ql/src/test/org/apache/hadoop/hive/ql/exec/TestStatsPublisherEnhanced.java
+++ b/src/ql/src/test/org/apache/hadoop/hive/ql/exec/TestStatsPublisherEnhanced.java
@@ -43,24 +43,25 @@ public class TestStatsPublisherEnhanced extends TestCase {
 
   public TestStatsPublisherEnhanced(String name) {
     super(name);
-  }
-
-  @Override
-  protected void setUp() {
     conf = new JobConf(TestStatsPublisherEnhanced.class);
-
     conf.set("hive.stats.dbclass", "jdbc:derby");
-
     statsImplementationClass = HiveConf.getVar(conf, HiveConf.ConfVars.HIVESTATSDBCLASS);
     StatsFactory.setImplementation(statsImplementationClass, conf);
+  }
 
+  @Override
+  protected void setUp() {
     stats = new HashMap<String, String>();
-    StatsAggregator sa = StatsFactory.getStatsAggregator();
-    sa.connect(conf);
-    sa.cleanUp("file_0");
-    sa.closeConnection();
   }
 
+  @Override
+  protected void tearDown() {
+    StatsAggregator sa = StatsFactory.getStatsAggregator();
+    assertNotNull(sa);
+    assertTrue(sa.connect(conf));
+    assertTrue(sa.cleanUp("file_0"));
+    assertTrue(sa.closeConnection());
+  }  
 
   private void fillStatMap(String numRows, String rawDataSize) {
     stats.clear();
-- 
1.7.0.4

