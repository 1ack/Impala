From b15ad1d1e67ec061d9224d5490728c205eddcb80 Mon Sep 17 00:00:00 2001
From: Carl Steinbach <carl@cloudera.com>
Date: Thu, 12 Jan 2012 03:16:33 -0800
Subject: [PATCH 12/58] HIVE-2697. Ant compile-test target should be triggered from subprojects, not from top-level targets

Reason: Bug
Author: Carl Steinbach
Ref: CDH-4122
---
 build-common.xml |    2 +-
 build.properties |   12 ++++++++++++
 build.xml        |   50 +++++++++-----------------------------------------
 common/build.xml |    2 +-
 4 files changed, 23 insertions(+), 43 deletions(-)

diff --git a/src/build-common.xml b/src/build-common.xml
index 055fcb5..6c1b441 100644
--- a/src/build-common.xml
+++ b/src/build-common.xml
@@ -403,7 +403,7 @@
 
   <!-- target to run the tests -->
   <target name="test"
-  	depends="test-conditions,gen-test,compile-test,test-jar,test-init">
+  	depends="clean-test,test-conditions,gen-test,compile-test,test-jar,test-init">
     <echo message="Project: ${ant.project.name}"/>
     <!--<property name="testcp" refid="test.classpath"/>-->
     <!--<echo message="test.classpath: ${testcp}"/>-->
diff --git a/src/build.properties b/src/build.properties
index f5a99e7..632d604 100644
--- a/src/build.properties
+++ b/src/build.properties
@@ -19,6 +19,18 @@ hadoop.mirror2=http://archive.cloudera.com/hive-deps
 build.dir.hive=${hive.root}/build
 build.dir.hadoop=${build.dir.hive}/hadoopcore
 
+# All submodules
+build.modulelist.all=ant/build.xml,shims/build.xml,common/build.xml,serde/build.xml,metastore/build.xml,ql/build.xml,contrib/build.xml,service/build.xml,cli/build.xml,jdbc/build.xml,hwi/build.xml,hbase-handler/build.xml,pdk/build.xml,builtins/build.xml
+
+# Submodules with tests
+build.modulelist.test=shims/build.xml,common/build.xml,serde/build.xml,metastore/build.xml,cli/build.xml,pdk/build.xml,builtins/build.xml,ql/build.xml,hwi/build.xml,jdbc/build.xml,contrib/build.xml,service/build.xml,hbase-handler/build.xml
+
+# Submodules with Thrift IDL files
+build.modulelist.thrift=ql/build.xml,service/build.xml,metastore/build.xml,serde/build.xml
+
+# Submodules with CPP components
+build.modulelist.cpp=odbc/build.xml
+
 
 hadoop.version.ant-internal=${hadoop.version}
 hadoop.root.default=${build.dir.hadoop}/hadoop-${hadoop.version.ant-internal}
diff --git a/src/build.xml b/src/build.xml
index 157ee14..d2d6c6e 100644
--- a/src/build.xml
+++ b/src/build.xml
@@ -133,8 +133,7 @@
       <subant target="@{target}">
 	<property name="thrift.home" value="${thrift.home}"/>
         <property name="build.dir.hive" location="${build.dir.hive}"/>
-        <!-- TODO filelist dir="." files="metastore/build.xml,serde/build.xml,service/build.xml,odbc/build.xml"/-->
-        <filelist dir="." files="odbc/build.xml"/>
+        <filelist dir="." files="${build.modulelist.cpp}"/>
       </subant>
     </sequential>
   </macrodef>
@@ -145,7 +144,7 @@
       <subant target="@{target}">
 	<property name="thrift.home" value="${thrift.home}"/>
         <property name="build.dir.hive" location="${build.dir.hive}"/>
-        <filelist dir="." files="ql/build.xml,contrib/build.xml,hbase-handler/build.xml,hwi/build.xml,jdbc/build.xml,metastore/build.xml,odbc/build.xml,serde/build.xml,service/build.xml"/>
+        <filelist dir="." files="${build.modulelist.test}"/>
       </subant>
     </sequential>
   </macrodef>
@@ -156,7 +155,7 @@
       <subant target="@{target}">
 	<property name="thrift.home" value="${thrift.home}"/>
         <property name="build.dir.hive" location="${build.dir.hive}"/>
-        <filelist dir="." files="ql/build.xml,service/build.xml,metastore/build.xml,serde/build.xml"/>
+        <filelist dir="." files="${build.modulelist.thrift}"/>
       </subant>
     </sequential>
   </macrodef>
@@ -167,18 +166,7 @@
       <subant target="@{target}">
         <property name="build.dir.hive" location="${build.dir.hive}"/>
         <property name="is-offline" value="${is-offline}"/>
-        <filelist dir="." files="ant/build.xml,shims/build.xml,common/build.xml,serde/build.xml,metastore/build.xml,ql/build.xml,contrib/build.xml,service/build.xml,cli/build.xml,jdbc/build.xml,hwi/build.xml,hbase-handler/build.xml,ant/build.xml,pdk/build.xml,builtins/build.xml"/>
-      </subant>
-    </sequential>
-  </macrodef>
-
-  <macrodef name="iterate">
-    <attribute name="target"/>
-    <sequential>
-      <subant target="@{target}">
-        <property name="build.dir.hive" location="${build.dir.hive}"/>
-        <property name="is-offline" value="${is-offline}"/>
-        <filelist dir="." files="shims/build.xml,common/build.xml,serde/build.xml,metastore/build.xml,ql/build.xml,contrib/build.xml,service/build.xml,cli/build.xml,jdbc/build.xml,hwi/build.xml,hbase-handler/build.xml,pdk/build.xml,builtins/build.xml"/>
+        <filelist dir="." files="${build.modulelist.all}"/>
       </subant>
     </sequential>
   </macrodef>
@@ -292,7 +280,6 @@
     <taskdef name="getversionpref" classname="org.apache.hadoop.hive.ant.GetVersionPref"
              classpath="${build.dir.hive}/anttasks/hive-anttasks-${version}.jar"/>
   </target>
-
   
   <target name="compile-cpp"
           depends="init"
@@ -313,7 +300,7 @@
 
   <target name="compile" depends="compile-cpp">
     <echo message="Project: ${ant.project.name}"/>
-    <iterate target="compile"/>
+    <iterate-all target="compile"/>
   </target>
 
   <target name="thriftif">
@@ -325,23 +312,17 @@
           depends="init"
           description="Build JAR artifacts">
     <echo message="Project: ${ant.project.name}"/>
-    <iterate target="jar"/>
+    <iterate-all target="jar"/>
   </target>
 
-  <target name="jar-test" depends="jar"
-          description="Build Java test artifacts">
-    <echo message="Project: ${ant.project.name}"/>
-    <iterate-test target="compile-test"/>
-  </target>
-
-  <target name="test" depends="clean-test,jar-test" description="Run tests">
+  <target name="test" depends="init" description="Run tests">
     <echo message="Project: ${ant.project.name}"/>
     <antcall target="test-shims">
       <param name="hadoop.version.ant-internal" value="${hadoop.security.version}" />
     </antcall>
     <for keepgoing="${test.continue.on.failure}" param="file">
       <path>
-        <fileset dir="." includes="*/build.xml" excludes="ant/*,odbc/*,shims/*"/>
+        <filelist dir="." files="${build.modulelist.test}"/>
       </path>
       <sequential>
         <ant antfile="@{file}" target="test" inheritAll="false" inheritRefs="true">
@@ -377,7 +358,7 @@
   <target name="clean-test"
           description="Clean test results">
     <echo message="Project: ${ant.project.name}"/>
-    <iterate target="clean-test"/>
+    <iterate-all target="clean-test"/>
     <delete dir="${build.dir.hive}/test"/>
     <delete dir="${hive.root}/ql/TempStatsStore"/>
   </target>
@@ -408,19 +389,6 @@
   <target name="very-clean" unless="offline" depends="ivy-clean-cache,clean"
           description="Clean build artifacts and flush Ivy cache" />
 
-  <!-- ====================================================== -->
-  <!-- Generate some of the test data.                        -->
-  <!-- ====================================================== -->
-  <target name="gen-testdata"
-          depends="jar"
-          description="Generate test data">
-    <echo message="Project: ${ant.project.name}"/>
-    <subant target="gen-testdata">
-      <property name="build.dir.hive" location="${build.dir.hive}"/>
-      <fileset dir="." includes="serde/build.xml"/>
-    </subant>
-  </target>
-
   <target name="package-cpp"
           depends="package,compile-cpp"
           description="Deploy CPP artifacts">
diff --git a/src/common/build.xml b/src/common/build.xml
index 0d0665f..4ab7555 100755
--- a/src/common/build.xml
+++ b/src/common/build.xml
@@ -47,7 +47,7 @@ to call at top-level: ant deploy-contrib compile-core-test
 
   <!-- target to run the tests -->
   <target name="test"
-  	depends="test-conditions,gen-test,compile-test,test-jar,test-init">
+  	depends="clean-test,test-conditions,gen-test,compile-test,test-jar,test-init">
     <echo message="Project: ${ant.project.name}"/>
     <junit showoutput="${test.output}" printsummary="yes" haltonfailure="no"
            fork="yes" maxmemory="512m" dir="${basedir}" timeout="${test.timeout}"
-- 
1.7.0.4

